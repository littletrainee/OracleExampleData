DECLARE
    V_EXIST NUMBER;
BEGIN
    SELECT COUNT(*)
      INTO V_EXIST
      FROM USER_TABLES
     WHERE TABLE_NAME = 'EMPLOYEES';
    IF V_EXIST <> 0 THEN
        EXECUTE IMMEDIATE 'DROP TABLE EMPLOYEES CASCADE CONSTRAINT PURGE';
    END IF; 
END;
/

CREATE TABLE EMPLOYEES(
    EMPLOYEE_ID CHAR(9),
    FIRST_NAME VARCHAR2(20) NOT NULL,
    MIDDLE_INITIAL CHAR(1),
    LAST_NAME VARCHAR2(30) NOT NULL,
    JOB_ID NUMBER(5,0) DEFAULT 1 NOT NULL,
    JOB_LEVEL NUMBER(3,0) DEFAULT 10,
    PUBLISHER_ID CHAR(4) DEFAULT '9952' NOT NULL,
    HIRE_DATE DATE DEFAULT SYSDATE NOT NULL,
    CONSTRAINT PK_EMPLOYEES PRIMARY KEY (EMPLOYEE_ID),
    CONSTRAINT FK_EMPLOYEES_JOB_ID FOREIGN KEY (JOB_ID) REFERENCES JOBS (JOB_ID),
    CONSTRAINT FK_EMPLOYEES_PUBLISHER_ID FOREIGN KEY (PUBLISHER_ID) REFERENCES PUBLISHERS (PUBLISHER_ID),
    CONSTRAINT CK_EMPLOYEES_EMPLOYEE_ID CHECK (REGEXP_LIKE(EMPLOYEE_ID, '^[A-Z]{3}[1-9][0-9]{4}[FM]') OR REGEXP_LIKE(EMPLOYEE_ID, '^[A-Z]-[A-Z][1-9][0-9]{4}[FM]'))
);

CREATE OR REPLACE TRIGGER TRI_CHECK_EMP_JOB_ID_AND_LEVEL
BEFORE INSERT OR UPDATE ON EMPLOYEES
FOR EACH ROW
BEGIN
    -- 驗證條件 1: JOB_ID 為 1 時，JOB_LEVEL 必須為 10
    IF :NEW.JOB_ID = 1 AND :NEW.JOB_LEVEL <> 10 THEN
        RAISE_APPLICATION_ERROR(-20001, 'Job id 1 expects the default level of 10.');
    END IF;

    DECLARE -- 驗證條件 2: JOB_LEVEL 必須在 JOBS.MIN_LEVEL 和 JOBS.MAX_LEVEL 範圍內
        V_MIN_LEVEL JOBS.MIN_LEVEL%TYPE;
        V_MAX_LEVEL JOBS.MAX_LEVEL%TYPE;
    BEGIN
        -- 從 JOBS 表中獲取對應的 MIN_LEVEL 和 MAX_LEVEL
        SELECT J.MIN_LEVEL, J.MAX_LEVEL
            INTO V_MIN_LEVEL, V_MAX_LEVEL
          FROM JOBS J
         WHERE J.JOB_ID = :NEW.JOB_ID;

        IF :NEW.JOB_LEVEL < V_MIN_LEVEL OR :NEW.JOB_LEVEL > V_MAX_LEVEL THEN
            RAISE_APPLICATION_ERROR(
                -20002,
                'The level for job_id ' || :NEW.JOB_ID || ' should be between ' || V_MIN_LEVEL || ' and ' || V_MAX_LEVEL || '.'
            );
        END IF;
   END;
END;
/

CREATE INDEX IDX_EMPLOYEES_FULL_NAME ON EMPLOYEES (LAST_NAME, MIDDLE_INITIAL, FIRST_NAME);

INSERT INTO EMPLOYEES VALUES ('PTC11962M', 'Philip', 'T', 'Cramer', 2, 215, '9952', TO_DATE('1989/11/11', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('AMD15433F', 'Ann', 'M', 'Devon', 3, 200, '9952', TO_DATE('1991/07/16', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('F-C16315M', 'Francisco', '', 'Chang', 4, 227, '9952', TO_DATE('1990/11/03', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('LAL21447M', 'Laurence', 'A', 'Lebihan', 5, 175, '0736', TO_DATE('1990/06/03', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('PXH22250M', 'Paul', 'X', 'Henriot', 5, 159, '0877', TO_DATE('1993/08/19', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('SKO22412M', 'Sven', 'K', 'Ottlieb', 5, 150, '1389', TO_DATE('1991/04/05', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('RBM23061F', 'Rita', 'B', 'Muller', 5, 198, '1622', TO_DATE('1993/10/09', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('MJP25939M', 'Maria', 'J', 'Pontes', 5, 246, '1756', TO_DATE('1983/03/01', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('JYL26161F', 'Janine', 'Y', 'Labrune', 5, 172, '9901', TO_DATE('1991/05/26', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('CFH28514M', 'Carlos', 'F', 'Hernadez', 5, 211, '9999', TO_DATE('1989/04/21', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('VPA30890F', 'Victoria', 'P', 'Ashworth', 6, 140, '0877', TO_DATE('1990/09/13', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('L-B31947F', 'Lesley', '', 'Brown', 7, 120, '0877', TO_DATE('1991/02/13', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('ARD36773F', 'Anabela', 'R', 'Domingues', 8, 100, '0877', TO_DATE('1993/01/27', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('M-R38834F', 'Martine', '', 'Rance', 9, 75, '0877', TO_DATE('1992/02/05', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('PHF38899M', 'Peter', 'H', 'Franken', 10, 75, '0877', TO_DATE('1992/05/17', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('DBT39435M', 'Daniel', 'B', 'Tonini', 11, 75, '0877', TO_DATE('1990/01/01', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('H-B39728F', 'Helen', '', 'Bennett', 12, 35, '0877', TO_DATE('1989/09/21', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('PMA42628M', 'Paolo', 'M', 'Accorti', 13, 35, '0877', TO_DATE('1992/08/27', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('ENL44273F', 'Elizabeth', 'N', 'Lincoln', 14, 35, '0877', TO_DATE('1990/07/24', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('MGK44605M', 'Matti', 'G', 'Karttunen', 6, 220, '0736', TO_DATE('1994/05/01', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('PDI47470M', 'Palle', 'D', 'Ibsen', 7, 195, '0736', TO_DATE('1993/05/09', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('MMS49649F', 'Mary', 'M', 'Saveley', 8, 175, '0736', TO_DATE('1993/06/29', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('GHT50241M', 'Gary', 'H', 'Thomas', 9, 170, '0736', TO_DATE('1988/08/09', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('MFS52347M', 'Martin', 'F', 'Sommer', 10, 165, '0736', TO_DATE('1990/04/13', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('R-M53550M', 'Roland', '', 'Mendel', 11, 150, '0736', TO_DATE('1991/09/05', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('HAS54740M', 'Howard', 'A', 'Snyder', 12, 100, '0736', TO_DATE('1988/11/19', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('TPO55093M', 'Timothy', 'P', 'O''Rourke', 13, 100, '0736', TO_DATE('1988/06/19', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('KFJ64308F', 'Karin', 'F', 'Josephs', 14, 100, '0736', TO_DATE('1992/10/17', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('DWR65030M', 'Diego', 'W', 'Roel', 6, 192, '1389', TO_DATE('1991/12/16', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('M-L67958F', 'Maria', '', 'Larsson', 7, 135, '1389', TO_DATE('1992/03/27', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('PSP68661F', 'Paula', 'S', 'Parente', 8, 125, '1389', TO_DATE('1994/01/19', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('MAS70474F', 'Margaret', 'A', 'Smith', 9, 78, '1389', TO_DATE('1988/09/29', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('A-C71970F', 'Aria', '', 'Cruz', 10, 87, '1389', TO_DATE('1991/10/26', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('MAP77183M', 'Miguel', 'A', 'Paolino', 11, 112, '1389', TO_DATE('1992/12/07', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('Y-L77953M', 'Yoshi', '', 'Latimer', 12, 32, '1389', TO_DATE('1989/06/11', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('CGS88322F', 'Carine', 'G', 'Schmitt', 13, 64, '1389', TO_DATE('1992/07/07', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('PSA89086M', 'Pedro', 'S', 'Afonso', 14, 89, '1389', TO_DATE('1990/12/24', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('A-R89858F', 'Annette', '', 'Roulet', 6, 152, '9999', TO_DATE('1990/02/21', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('HAN90777M', 'Helvetius', 'A', 'Nagy', 7, 120, '9999', TO_DATE('1993/03/19', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('M-P91209M', 'Manuel', '', 'Pereira', 8, 101, '9999', TO_DATE('1989/01/09', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('KJJ92907F', 'Karla', 'J', 'Jablonski', 9, 170, '9999', TO_DATE('1994/03/11', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('POK93028M', 'Pirkko', 'O', 'Koskitalo', 10, 80, '9999', TO_DATE('1993/11/29', 'YYYY/MM/DD'));
INSERT INTO EMPLOYEES VALUES ('PCM98509F', 'Patricia', 'C', 'McKenna', 11, 150, '9999', TO_DATE('1989/08/01', 'YYYY/MM/DD'));